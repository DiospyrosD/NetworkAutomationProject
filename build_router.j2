udo ip netns add {{ network.routers[0].subnet_id }}
{% for item in network.subnets %}
{% if item.switch %}
{% set parts = item.gw.split('.') %}
{% set last_octet = parts[-1] | int %}
{% set incremented_last_octet = last_octet + 2 %}
{% set modified_parts = parts[:-1] + [incremented_last_octet | string] %}
sudo ovs-vsctl add-port {{item.subnet_id}}_sw {{item.subnet_id}}_sw_p2 -- set interface {{item.subnet_id}}_sw_p2 type=internal
sudo ip link set {{ item.subnet_id }}_sw_p2 netns {{ network.routers[0].subnet_id }}
sudo ip netns exec {{ network.routers[0].subnet_id }} ip link set dev {{item.subnet_id}}_sw_p2 up
sudo ip netns exec {{network.routers[0].subnet_id}} ip addr add {{ modified_parts | join('.') }}{{ item.cidr }} dev {{ item.subnet_id }}_sw_p2
sudo ovs-vsctl set port {{item.subnet_id}}_sw_p2 tag={{ item.vlan }}
{% endif %}
{% endfor %}
